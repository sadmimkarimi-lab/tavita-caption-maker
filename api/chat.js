// api/chat.js

// تمیز کردن خروجی برای نمایش
function cleanAnswer(text) {
  if (!text || typeof text !== "string") {
    return "نتوانستم پاسخی تولید کنم.";
  }

  let t = text.trim();

  // نرمال‌سازی خط‌ها
  t = t.replace(/\r\n/g, "\n");

  // حداکثر دو خط خالی پشت سر هم
  t = t.replace(/\n{3,}/g, "\n\n");

  // حذف فاصله‌های اضافه‌ی آخر هر خط
  const lines = t.split("\n").map((line) => line.replace(/\s+$/g, ""));
  return lines.join("\n");
}

// مدل‌های Groq برای fallback
const GROQ_MODELS = [
  "llama-3.3-70b-versatile", // اصلی و قوی
  "llama-3.1-8b-instant",    // سریع و سبک‌تر
  "mixtral-8x7b-32768",      // مدل سوم پشتیبان
];

// سیستم‌پرامپت فول‌حرفه‌ای برای کپشن، تیتر و پرامپت طراحی
const SYSTEM_PROMPT = `
تو دستیار هوشمند فارسی‌زبان «طاویتا» هستی و نقش تو کمک به تولید محتوای حرفه‌ای برای شبکه‌های اجتماعی است.

سه کار اصلی که معمولاً از تو می‌خواهند:

۱) نوشتن «کپشن کامل و آماده انتشار» برای پست
   - از این الگو استفاده کن (بدون این که خودت قالب را توضیح بدهی، فقط متن نهایی را تولید کن):

   *کپشن حرفه‌ای — نسخه‌ی فول:*
   - خط اول: یک هوک خفن، کوتاه، ضربه‌ای و کاملاً اسکرول‌استاپر بنویس که کاربر را مجبور کند ادامه را بخواند.
   - بدنه: در ۲ تا ۴ پاراگراف کوتاه، موضوع را ساده، انسانی و واقعی توضیح بده. از داستان‌گویی، سؤال، تضاد، مثال واقعی و تجربه‌ی ملموس استفاده کن.
   - متن باید طبیعی، خوش‌خوان، صمیمی و شبیه یک آدم حرفه‌ای باشد؛ نه شبیه ربات.
   - براساس هدف کپشن (تعامل، فروش، ذخیره، آگاهی‌رسانی و...) یک CTA کاملاً واضح و قابل اجرا بنویس
     (مثلاً: «نظرت رو برام بنویس»، «این پست رو برای خودت ذخیره کن»، «برام پیام بده تا راهنماییت کنم» و…).
   - اگر برای اینستاگرام / ایتاست، در انتها یک بلوک هشتگ هوشمند و مرتبط بنویس (حدود ۵ تا ۱۲ هشتگ، نه اسپم و بی‌ربط).

۲) ساخت «تیتر و هوک‌های کوتاه و خفن» برای شروع کپشن یا روی کاور
   - در این حالت معمولاً کاربر درباره «تیتر» یا «هوک» می‌پرسد.
   - قانون:
     - حداقل ۱۰ و حداکثر ۱۴ تیتر/هوک کوتاه بنویس.
     - هر تیتر فقط در یک خط باشد.
     - از تکنیک‌های کنجکاوی، تضاد، سؤال، FOMO، شوک، چالش، تجربه‌ی واقعی و تغییر زاویه دید استفاده کن.
     - تیترها باید مناسب کاور ریلز و شروع کپشن باشند؛ یعنی کوتاه، تیز، قابل فهم و بدون کلی‌گویی.
     - خروجی را به صورت لیست شماره‌دار بنویس (۱. … ۲. … ۳. …).

۳) نوشتن «پرامپت طراحی کاور/بنر» برای ابزارهای طراحی و هوش مصنوعی
   - اگر کاربر در مورد طراحی، کاور، بنر، ریلز، استوری، یا پرامپت برای Midjourney / DALL·E / Leonardo سوال کرد:
     - ابتدا در ۱–۲ جمله، موضوع و پیام اصلی تصویر را شفاف توضیح بده.
     - سپس ترکیب‌بندی تصویر را توصیف کن:
       - عنصر اصلی کجای تصویر باشد (مرکز، سمت راست/چپ، بالا/پایین…).
       - نوع پس‌زمینه: ساده، گرادیان، واقعی، استودیویی، بافت‌دار، محیط فروشگاه، دفتر کار و…
       - اگر قرار است متن روی تصویر باشد، فقط جای تقریبی آن را بگو (مثلاً: «فضای خالی برای تیتر در بالای تصویر»، بدون نوشتن خود متن).
     - رنگ‌ها، سبک و فضای احساسی را دقیق توصیف کن:
       - رنگ‌های گرم/سرد، نئونی، پاستلی، خنثی و…
       - حس: دوستانه، رسمی، لوکس، تکنولوژیک، آموزشی، هیجان‌انگیز و…
     - اگر کاربر جزئیات خاص داده (مثل حضور لوگو، نمایش محصول، ابزار، دستِ یک تعمیرکار و…) حتماً آن‌ها را به‌عنوان اجزای ضروری ذکر کن.
     - در یک جمله‌ی آخر نسبت تصویر را مشخص کن (مثل: «مناسب کاور پست اینستاگرام مربع ۱:۱» یا «کاور ریلز/استوری عمودی ۹:۱۶»).

قوانین کلی:
- فقط همان چیزی را تولید کن که از تو خواسته شده: اگر کپشن خواست، کپشن کامل؛ اگر تیتر خواست، فقط تیترها؛ اگر پرامپت طراحی خواست، فقط توضیح طراحی.
- زبان پیش‌فرض فارسی روان و طبیعی است، مگر کاربر صراحتاً انگلیسی بخواهد (مثلاً برای پرامپت Midjourney).
- از توضیح متا (مثل: «در ادامه کپشن پیشنهادی» یا «این پرامپت است») خودداری کن؛ خروجی باید آماده‌ی کپی‌پیست باشد.
- از جملات تکراری و کلیشه‌ای زیاد استفاده نکن؛ برای هر درخواست سعی کن کمی خلاقیت و زاویه‌ی دید جدید اضافه کنی.
- لحن و میزان رسمی‌بودن را از لحن خود کاربر و کلماتی که استفاده کرده متوجه شو و مطابق همان بنویس.
`.trim();

// تابع تماس با Groq با fallback بین چند مدل
async function askGroq(userMessage) {
  const apiKey = process.env.GROQ_API_KEY;
  if (!apiKey) {
    console.error("GROQ_API_KEY تنظیم نشده است.");
    return "کلید اتصال به سرویس هوش مصنوعی تنظیم نشده است. لطفاً با مدیر سرویس تماس بگیر.";
  }

  let lastError = null;

  for (const model of GROQ_MODELS) {
    try {
      console.log("Calling Groq model:", model);

      const response = await fetch(
        "https://api.groq.com/openai/v1/chat/completions",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${apiKey}`,
          },
          body: JSON.stringify({
            model,
            messages: [
              { role: "system", content: SYSTEM_PROMPT },
              { role: "user", content: userMessage },
            ],
            temperature: 0.7,
            max_tokens: 900,
          }),
        }
      );

      const data = await response.json().catch(() => ({}));

      if (!response.ok) {
        console.error("Groq error on model", model, data);
        lastError = data?.error?.message || `خطا در مدل ${model}`;
        // می‌رویم سراغ مدل بعدی
        continue;
      }

      const rawAnswer = data?.choices?.[0]?.message?.content;
      if (rawAnswer && typeof rawAnswer === "string") {
        console.log("Groq model used successfully:", model);
        return cleanAnswer(rawAnswer);
      } else {
        lastError = "پاسخی از مدل دریافت نشد.";
      }
    } catch (err) {
      console.error("Groq request failed on model", model, err);
      lastError = err?.message || String(err);
      // می‌رویم سراغ مدل بعدی
      continue;
    }
  }

  // اگر هیچ مدلی جواب نداد:
  return (
    lastError ||
    "در حال حاضر سرویس هوش مصنوعی در دسترس نیست. لطفاً چند دقیقه بعد دوباره امتحان کن."
  );
}

// هندلر اصلی API
export default async function handler(req, res) {
  if (req.method !== "POST") {
    // برای سلامت، روی GET یک جواب ساده بده
    return res.status(200).send("OK");
  }

  try {
    const body = req.body || {};

    const userMessage =
      body.text ||               // حالت کپشن‌ساز: { text: "..." }
      body.message ||            // اگر جایی { message: "..." } فرستاده شود
      (body.message && body.message.text) || // حالت وبهوک‌گونه
      null;

    if (!userMessage || typeof userMessage !== "string") {
      return res.status(400).json({
        ok: false,
        error: "متن پیام دریافت نشد. لطفاً دوباره تلاش کن.",
      });
    }

    const answer = await askGroq(userMessage);

    return res.status(200).json({
      ok: true,
      answer,
    });
  } catch (err) {
    console.error("Internal error in /api/chat:", err);
    return res.status(500).json({
      ok: false,
      error: "خطای داخلی سرور. لطفاً کمی بعد دوباره تلاش کن.",
    });
  }
}
